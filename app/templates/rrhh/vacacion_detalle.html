{% extends "base.html" %}

{% block title %}Historial Vacaciones - {{ empleado.nombre_completo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-8">
            <h3><i class="bi bi-person-badge"></i> Historial de Vacaciones: {{ empleado.nombre_completo }}</h3>
            <p class="text-muted mb-1">C√≥digo: <strong>{{ empleado.codigo }}</strong></p>
            <p class="text-muted mb-1">Antig√ºedad: <strong>{{ empleado.antiguedad_texto }}</strong></p>
            {% if empleado.dias_vacaciones_actuales %}
            <p class="text-info mb-0">
                <i class="bi bi-calendar-check"></i> 
                D√≠as de vacaciones por antig√ºedad: <strong>{{ empleado.dias_vacaciones_actuales }} d√≠as/a√±o</strong>
            </p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('rrhh.listar_vacaciones') }}" class="btn btn-secondary">‚Üê Volver</a>
        </div>
    </div>

    <!-- Alerta de vencimiento -->
    {% if saldo and saldo.alerta %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h5 class="alert-heading">‚ö†Ô∏è Alerta de Vencimiento de Vacaciones</h5>
        <p class="mb-2">
            <strong>{{ empleado.nombre_completo }}</strong> tiene <strong>{{ saldo.por_vencer }} d√≠as</strong> acumulados que vencer√°n pronto.
        </p>
        <hr>
        <p class="mb-0">
            üìÖ <strong>D√≠as por vencer:</strong> {{ saldo.por_vencer }} d√≠as<br>
            üìÜ <strong>Fecha l√≠mite:</strong> {{ saldo.fecha_vencimiento.strftime('%d/%m/%Y') if saldo.fecha_vencimiento else 'N/A' }}<br>
            <small class="text-muted">Si no se toman vacaciones antes de esta fecha, estos d√≠as se perder√°n seg√∫n el C√≥digo Laboral Paraguayo (m√°ximo 2 a√±os de acumulaci√≥n).</small>
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Resumen de saldo actual -->
    {% if saldo %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <strong><i class="bi bi-calculator"></i> Resumen de Saldo de Vacaciones (C√°lculo Autom√°tico)</strong>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center p-3 border rounded">
                        <h4 class="text-primary mb-0">{{ saldo.disponibles_total }}</h4>
                        <small class="text-muted">D√≠as Disponibles (3 a√±os)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 border rounded">
                        <h4 class="text-danger mb-0">{{ saldo.tomados_total }}</h4>
                        <small class="text-muted">D√≠as Tomados</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 border rounded">
                        <h4 class="text-success mb-0">{{ saldo.pendientes }}</h4>
                        <small class="text-muted">D√≠as Pendientes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 border rounded {% if saldo.alerta %}bg-warning{% endif %}">
                        <h4 class="mb-0 {% if saldo.alerta %}text-dark{% else %}text-muted{% endif %}">{{ saldo.por_vencer }}</h4>
                        <small class="{% if saldo.alerta %}text-dark{% else %}text-muted{% endif %}">Por Vencer</small>
                    </div>
                </div>
            </div>

            <!-- Desglose por a√±o -->
            {% if saldo.desglose_a√±os %}
            <hr>
            <h6 class="mb-3"><i class="bi bi-list-ul"></i> Desglose por A√±o:</h6>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>A√±o</th>
                        <th>D√≠as Ganados</th>
                        <th>D√≠as Tomados</th>
                        <th>Saldo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detalle in saldo.desglose_a√±os %}
                    <tr {% if detalle.vence %}class="table-warning"{% endif %}>
                        <td><strong>{{ detalle.a√±o }}</strong></td>
                        <td>{{ detalle.ganados }}</td>
                        <td>{{ detalle.tomados }}</td>
                        <td><strong>{{ detalle.saldo }}</strong></td>
                        <td>
                            {% if detalle.vence %}
                                <span class="badge bg-warning text-dark">‚ö†Ô∏è Vence 31/12/{{ detalle.a√±o + 2 }}</span>
                            {% else %}
                                <span class="badge bg-success">Vigente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> Los d√≠as de vacaciones se calculan autom√°ticamente desde la fecha de ingreso y vencen despu√©s de 2 a√±os.
            </small>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <strong>Solicitudes pendientes</strong>
        </div>
        <div class="card-body">
            {% if pendientes %}
                <div class="list-group">
                {% for p in pendientes %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">Periodo: {{ p.a√±o }}</h5>
                            <small class="text-warning">Estado: {{ p.estado.value }}</small>
                        </div>
                        <p class="mb-1">Fechas solicitadas: {{ p.fecha_inicio_solicitud.strftime('%d/%m/%Y') if p.fecha_inicio_solicitud else '-' }} - {{ p.fecha_fin_solicitud.strftime('%d/%m/%Y') if p.fecha_fin_solicitud else '-' }}</p>
                        {% if p.fecha_inicio_solicitud and p.fecha_fin_solicitud %}
                        <p class="mb-1">D√≠as solicitados: {{ (p.fecha_fin_solicitud - p.fecha_inicio_solicitud).days + 1 }}</p>
                        {% else %}
                        <p class="mb-1">D√≠as solicitados: -</p>
                        {% endif %}
                        <div>
                            <form action="{{ url_for('rrhh.aprobar_vacacion', vacacion_id=p.id) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-success">Aprobar</button>
                            </form>
                            <form action="{{ url_for('rrhh.rechazar_vacacion', vacacion_id=p.id) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-danger">Rechazar</button>
                            </form>
                            <a href="{{ url_for('rrhh.imprimir_solicitud_vacacion_directa', empleado_id=empleado.id) }}?vacacion_id={{ p.id }}" class="btn btn-sm btn-outline-secondary ms-2">Imprimir</a>
                            <span class="d-none pendiente-option" data-id="{{ p.id }}">Solicitud {{ p.a√±o }}: {{ (p.fecha_fin_solicitud - p.fecha_inicio_solicitud).days + 1 if p.fecha_inicio_solicitud and p.fecha_fin_solicitud else 0 }} d√≠as</span>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No hay solicitudes pendientes para este empleado.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <strong>Historial completo de vacaciones</strong>
        </div>
        <div class="card-body">
            {% if vacaciones %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>A√±o</th>
                            <th>Disponibles</th>
                            <th>Tomados</th>
                            <th>Pendientes</th>
                            <th>Fecha Inicio Solicitud</th>
                            <th>Fecha Fin Solicitud</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in vacaciones %}
                        <tr>
                            <td>{{ v.a√±o }}</td>
                            <td>{{ v.dias_disponibles }}</td>
                            <td>{{ v.dias_tomados }}</td>
                            <td>{{ v.dias_pendientes }}</td>
                            <td>{{ v.fecha_inicio_solicitud or '-' }}</td>
                            <td>{{ v.fecha_fin_solicitud or '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if v.estado.name == 'APROBADA' else 'warning' if v.estado.name == 'PENDIENTE' else 'danger' }}">{{ v.estado.value }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No hay historial de vacaciones para este empleado.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
