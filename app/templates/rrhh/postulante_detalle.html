{% extends "base.html" %}

{% block title %}Postulante: {{ postulante.nombre }} {{ postulante.apellido }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header con botones de acci√≥n -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3">
                <i class="bi bi-person-circle"></i> {{ postulante.nombre }} {{ postulante.apellido }}
            </h1>
            <p class="text-muted">{{ postulante.cargo_postulado }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('rrhh.postulantes_lista') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Informaci√≥n del postulante -->
        <div class="col-lg-8">
            <!-- Card de Informaci√≥n General -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">Informaci√≥n General</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Email:</strong>
                            <p><a href="mailto:{{ postulante.email }}">{{ postulante.email }}</a></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Tel√©fono:</strong>
                            <p>{{ postulante.telefono or 'No registrado' }}</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha de Nacimiento:</strong>
                            <p>
                                {% if postulante.fecha_nacimiento %}
                                    {{ postulante.fecha_nacimiento.strftime('%d/%m/%Y') }}
                                {% else %}
                                    No registrada
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <strong>Nivel Acad√©mico:</strong>
                            <p>{{ postulante.nivel_academico or 'No especificado' }}</p>
                        </div>
                    </div>

                    <hr>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Cargo Postulado:</strong>
                            <p>{{ postulante.cargo_postulado }}</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Experiencia:</strong>
                            <p>{{ postulante.experiencia_a√±os }} a√±os</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <strong>Salario Esperado:</strong>
                            <p>
                                {% if postulante.salario_esperado %}
                                    Gs. {{ "{:,.0f}".format(postulante.salario_esperado) }}
                                {% else %}
                                    No especificado
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha de Postulaci√≥n:</strong>
                            <p>{{ postulante.fecha_postulacion.strftime('%d/%m/%Y') }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Observaciones -->
            {% if postulante.observaciones %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">Observaciones</h6>
                </div>
                <div class="card-body">
                    <p>{{ postulante.observaciones }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Card de Documentos del CV -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-file-earmark"></i> Documentos
                    </h6>
                </div>
                <div class="card-body">
                    {% if postulante.documentos %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nombre de Archivo</th>
                                    <th>Tama√±o</th>
                                    <th>Fecha Carga</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in postulante.documentos %}
                                <tr>
                                    <td>
                                        <span class="badge bg-info">{{ doc.tipo }}</span>
                                    </td>
                                    <td>{{ doc.nombre_archivo }}</td>
                                    <td>
                                        {% if doc.tama√±o_bytes %}
                                            {{ "{:.2f}".format(doc.tama√±o_bytes / 1024) }} KB
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ doc.fecha_carga.strftime('%d/%m/%Y %H:%M') if doc.fecha_carga else 'N/A' }}</td>
                                    <td>
                                        <a href="{{ url_for('rrhh.descargar_documento_postulante', postulante_id=postulante.id, doc_id=doc.id) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Descargar
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay documentos adjuntos.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Columna derecha: Estado y Acciones -->
        <div class="col-lg-4">
            <!-- Card de Estado -->
            <div class="card mb-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">Estado Actual</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {% if postulante.estado == 'Nuevo' %}
                        <span class="badge bg-info p-3 fs-6">{{ postulante.estado }}</span>
                        {% elif postulante.estado == 'En Evaluaci√≥n' %}
                        <span class="badge bg-warning text-dark p-3 fs-6">{{ postulante.estado }}</span>
                        {% elif postulante.estado == 'Contratado' %}
                        <span class="badge bg-success p-3 fs-6">{{ postulante.estado }}</span>
                        {% elif postulante.estado == 'Rechazado' %}
                        <span class="badge bg-danger p-3 fs-6">{{ postulante.estado }}</span>
                        {% elif postulante.estado == 'En Espera' %}
                        <span class="badge bg-secondary p-3 fs-6">{{ postulante.estado }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Bot√≥n Contratar -->
                    {% if postulante.estado != 'Contratado' and postulante.estado != 'Rechazado' %}
                    <div class="mb-4">
                        <button type="button" class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#modalContratar">
                            <i class="bi bi-person-check-fill"></i> üéâ Contratar como Empleado
                        </button>
                    </div>
                    {% endif %}

                    <form method="POST" action="{{ url_for('rrhh.postulante_cambiar_estado', postulante_id=postulante.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="estado" class="form-label">Cambiar Estado</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="{{ postulante.estado }}" selected>-- Seleccionar --</option>
                                <option value="Nuevo" {% if postulante.estado == 'Nuevo' %}disabled{% endif %}>Nuevo</option>
                                <option value="En Evaluaci√≥n" {% if postulante.estado == 'En Evaluaci√≥n' %}disabled{% endif %}>En Evaluaci√≥n</option>
                                <option value="Contratado" {% if postulante.estado == 'Contratado' %}disabled{% endif %}>Contratado</option>
                                <option value="Rechazado" {% if postulante.estado == 'Rechazado' %}disabled{% endif %}>Rechazado</option>
                                <option value="En Espera" {% if postulante.estado == 'En Espera' %}disabled{% endif %}>En Espera</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-circle"></i> Actualizar Estado
                        </button>
                    </form>
                </div>
            </div>

            <!-- Card de Informaci√≥n Adicional -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0 fw-bold">Informaci√≥n Adicional</h6>
                </div>
                <div class="card-body">
                    <strong>Creado:</strong>
                    <p class="text-muted">{{ postulante.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}</p>

                    <strong>√öltima Actualizaci√≥n:</strong>
                    <p class="text-muted">{{ postulante.fecha_actualizado.strftime('%d/%m/%Y %H:%M') }}</p>

                    {% if postulante.empleado_id %}
                    <div class="mt-3">
                        <strong>Empleado Asociado:</strong>
                        <p>
                            <a href="{{ url_for('rrhh.perfil_empleado', empleado_id=postulante.empleado_id) }}"
                               class="btn btn-sm btn-outline-success">
                                <i class="bi bi-person-check"></i> Ver Empleado
                            </a>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Contrataci√≥n -->
<div class="modal fade" id="modalContratar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-check-fill"></i> üéâ Contratar a {{ postulante.nombre }} {{ postulante.apellido }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('rrhh.postulante_contratar', postulante_id=postulante.id) }}" id="formContratar">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <!-- Datos del Postulante -->
                    <div class="alert alert-info">
                        <h6 class="mb-2">‚úÖ Datos del Postulante (se copiar√°n al empleado):</h6>
                        <ul class="mb-0">
                            <li><strong>Nombre:</strong> {{ postulante.nombre }} {{ postulante.apellido }}</li>
                            {% if postulante.email %}<li><strong>Email:</strong> {{ postulante.email }} <small class="text-muted">(puede modificar abajo)</small></li>{% endif %}
                            {% if postulante.telefono %}<li><strong>Tel√©fono:</strong> {{ postulante.telefono }}</li>{% endif %}
                            {% if postulante.fecha_nacimiento %}<li><strong>Fecha Nac.:</strong> {{ postulante.fecha_nacimiento.strftime('%d/%m/%Y') }}</li>{% endif %}
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Datos Faltantes Obligatorios:</strong>
                        <p class="mb-0 small">Complete los siguientes campos para crear el empleado</p>
                    </div>
                    
                    <!-- Campos Obligatorios -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ci" class="form-label">C√©dula de Identidad <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ci" name="ci" required 
                                   placeholder="1234567" pattern="[0-9]+" maxlength="20">
                            <div class="form-text">Solo n√∫meros, sin puntos ni guiones</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="codigo" class="form-label">C√≥digo Empleado <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required
                                   placeholder="EMP-001" value="{{ codigo_sugerido }}">
                            <div class="form-text">C√≥digo √∫nico del empleado</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cargo_id" class="form-label">Cargo <span class="text-danger">*</span></label>
                            <select class="form-select" id="cargo_id" name="cargo_id" required>
                                <option value="">‚Äî Seleccionar Cargo ‚Äî</option>
                                {% for cargo in cargos %}
                                <option value="{{ cargo.id }}" 
                                        data-salario="{{ cargo.salario_base }}"
                                        {% if postulante.cargo_postulado and cargo.nombre|lower in postulante.cargo_postulado|lower %}selected{% endif %}>
                                    {{ cargo.nombre }} (Gs. {{ "{:,.0f}".format(cargo.salario_base) }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="salario_base" class="form-label">Salario Base <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="salario_base" name="salario_base" required
                                   value="{{ postulante.salario_esperado or '' }}" step="1000" min="0">
                            <div class="form-text">Guaran√≠es mensuales</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha_ingreso" class="form-label">Fecha de Ingreso <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" required
                                   value="{{ fecha_hoy }}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo" name="sexo">
                                <option value="">‚Äî No especificar ‚Äî</option>
                                <option value="M">Masculino</option>
                                <option value="F">Femenino</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campos Opcionales -->
                    <hr>
                    <h6 class="mb-3">Datos Opcionales:</h6>
                    
                    <div class="mb-3">
                        <label for="email_empleado" class="form-label">Email del Empleado</label>
                        <input type="email" class="form-control" id="email_empleado" name="email_empleado"
                               value="{{ postulante.email or '' }}" placeholder="email@ejemplo.com">
                        <div class="form-text">‚ö†Ô∏è Si el email ya existe, modif√≠quelo o d√©jelo vac√≠o</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="direccion" class="form-label">Direcci√≥n</label>
                            <input type="text" class="form-control" id="direccion" name="direccion"
                                   placeholder="Calle, barrio, ciudad">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="nacionalidad" class="form-label">Nacionalidad</label>
                            <input type="text" class="form-control" id="nacionalidad" name="nacionalidad"
                                   value="Paraguaya" placeholder="Paraguaya">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ips_numero" class="form-label">N√∫mero IPS</label>
                        <input type="text" class="form-control" id="ips_numero" name="ips_numero"
                               placeholder="N√∫mero de asegurado en IPS">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle-fill"></i> ‚úÖ Confirmar Contrataci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Abrir modal autom√°ticamente si llegan con #contratar
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash === '#contratar') {
        const modal = new bootstrap.Modal(document.getElementById('modalContratar'));
        modal.show();
    }
});

// Auto-actualizar salario cuando se selecciona un cargo
document.getElementById('cargo_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const salario = selectedOption.getAttribute('data-salario');
    if (salario) {
        document.getElementById('salario_base').value = salario;
    }
});

// Validaci√≥n del formulario
document.getElementById('formContratar').addEventListener('submit', function(e) {
    const ci = document.getElementById('ci').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    const cargo_id = document.getElementById('cargo_id').value;
    const salario = document.getElementById('salario_base').value;
    
    if (!ci || !codigo || !cargo_id || !salario) {
        e.preventDefault();
        alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios marcados con *');
        return false;
    }
    
    if (!/^[0-9]+$/.test(ci)) {
        e.preventDefault();
        alert('‚ö†Ô∏è La c√©dula debe contener solo n√∫meros');
        document.getElementById('ci').focus();
        return false;
    }
    
    return true;
});
</script>

{% endblock %}
