{% extends "base.html" %}

{% block title %}Asistencia - Sistema RRHH{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-clock"></i> Control de Asistencia</h2>
        </div>
        <div class="col-md-4">
            <input type="date" id="fechaFiltro" class="form-control" value="{{ fecha }}" onchange="filtrarAsistencia()">
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-qr-code"></i> Registrar Asistencia</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="codigoEmpleado" class="form-label">Código del Empleado</label>
                        <input type="text" class="form-control form-control-lg" id="codigoEmpleado" placeholder="Escanear o ingresar código" autofocus>
                    </div>
                    <div id="resultadoAsistencia"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <p><strong>Fecha:</strong> <span id="fechaActual"></span></p>
                    <p><strong>Hora:</strong> <span id="horaActual"></span></p>
                    <p class="text-muted">Ingrese el código del empleado para registrar entrada o salida.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-list"></i> Asistencias del {{ fecha }}</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover datatable">
                <thead class="table-dark">
                    <tr>
                        <th>Código</th>
                        <th>Empleado</th>
                        <th>Hora Entrada</th>
                        <th>Hora Salida</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asistencia in asistencias.items %}
                    <tr>
                        <td><strong>{{ asistencia.empleado.codigo }}</strong></td>
                        <td>{{ asistencia.empleado.nombre_completo }}</td>
                        <td>
                            {% if asistencia.hora_entrada %}
                                <span class="badge bg-success">{{ asistencia.hora_entrada.strftime('%H:%M:%S') }}</span>
                            {% else %}
                                <span class="badge bg-secondary">--:--:--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if asistencia.hora_salida %}
                                <span class="badge bg-danger">{{ asistencia.hora_salida.strftime('%H:%M:%S') }}</span>
                            {% else %}
                                <span class="badge bg-warning">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#editarAsistenciaModal" onclick="editarAsistencia({{ asistencia.id }})" class="btn btn-sm btn-primary">
                                <i class="bi bi-pencil"></i> Editar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Editar Asistencia -->
<div class="modal fade" id="editarAsistenciaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Asistencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editarAsistenciaForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="hora_entrada" class="form-label">Hora Entrada</label>
                        <input type="time" class="form-control" id="hora_entrada" name="hora_entrada">
                    </div>
                    <div class="mb-3">
                        <label for="hora_salida" class="form-label">Hora Salida</label>
                        <input type="time" class="form-control" id="hora_salida" name="hora_salida">
                    </div>
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Actualizar fecha y hora actual
function actualizarReloj() {
    const ahora = new Date();
    document.getElementById('fechaActual').textContent = ahora.toLocaleDateString('es-PY');
    document.getElementById('horaActual').textContent = ahora.toLocaleTimeString('es-PY');
}

setInterval(actualizarReloj, 1000);
actualizarReloj();

// Registrar asistencia
document.getElementById('codigoEmpleado').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        registrarAsistencia(this.value);
        this.value = '';
        this.focus();
    }
});

function registrarAsistencia(codigo) {
    // Obtener CSRF token del meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('{{ url_for("rrhh.registrar_asistencia") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ codigo: codigo })
    })
    .then(response => response.json())
    .then(data => {
        const resultadoDiv = document.getElementById('resultadoAsistencia');
        if (data.success) {
            resultadoDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <strong>${data.tipo.toUpperCase()}:</strong> ${data.message}<br>
                    <small>Hora: ${data.hora}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => location.reload(), 2000);
        } else {
            resultadoDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function filtrarAsistencia() {
    const fecha = document.getElementById('fechaFiltro').value;
    window.location.href = '{{ url_for("rrhh.ver_asistencia") }}?fecha=' + fecha;
}

function editarAsistencia(id) {
    // Cargar datos para edición
    document.getElementById('editarAsistenciaForm').action = '{{ url_for("rrhh.editar_asistencia", asistencia_id=0) }}'.replace('0', id);
}
</script>
{% endblock %}
