{% extends "base.html" %}

{% block title %}Registrar Despido{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2 class="mb-4">
                <i class="fas fa-user-slash"></i> Registrar Despido de Empleado
            </h2>
            
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="POST" class="needs-validation" id="formDespido">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Seleccionar empleado -->
                        <div class="form-group mb-3">
                            <label for="empleado_id" class="form-label fw-bold">Seleccionar Empleado</label>
                            <select id="empleado_id" name="empleado_id" class="form-control" required onchange="cargar_datos_empleado()">
                                <option value="">-- Seleccionar empleado --</option>
                                {% for emp in empleados %}
                                    <option value="{{ emp.id }}" data-salario="{{ emp.salario_base }}" data-fecha-ingreso="{{ emp.fecha_ingreso.strftime('%Y-%m-%d') if emp.fecha_ingreso else '' }}">
                                        {{ emp.nombre }} ({{ emp.ci }})
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Selecciona un empleado activo</small>
                        </div>
                        
                        <!-- Datos del empleado (informaci√≥n) -->
                        <div id="div_datos_empleado" style="display:none;" class="alert alert-info mb-3">
                                                <p><strong>Antig√ºedad:</strong> <span id="span_antiguedad">---</span> a√±os</p>
                                                <p><strong>Salario Base:</strong> <span id="span_salario">---</span></p>
                                                <p><strong>Fecha Ingreso:</strong> <span id="span_fecha_ingreso">---</span></p>
                                            </div>
                        
                        <!-- Tipo de despido -->
                        <div class="form-group mb-3">
                            <label for="tipo" class="form-label fw-bold">Tipo de Despido</label>
                            <select id="tipo" name="tipo" class="form-control" required onchange="mostrar_causal(); calcular_indemnizacion();">
                                <option value="">-- Seleccionar --</option>
                                <option value="justificado">
                                    ‚úì Justificado (Con Causa Legal)
                                </option>
                                <option value="injustificado">
                                    ‚úó Injustificado (Sin Causa / Arbitrario)
                                </option>
                            </select>
                            <small class="form-text text-muted">Define si hay causal legal v√°lida</small>
                        </div>
                        
                        <!-- Causal (si justificado) -->
                        <div class="form-group mb-3" id="div_causal" style="display:none;">
                            <label for="causal" class="form-label fw-bold">Causal Legal (Justificado)</label>
                            <select id="causal" name="causal" class="form-control" onchange="calcular_indemnizacion();">
                                <option value="">-- Seleccionar causal --</option>
                                {% for codigo, label in causales %}
                                    <option value="{{ codigo }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Causal legal que justifica el despido (Art. 79 C√≥digo Laboral)</small>
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div class="form-group mb-3">
                            <label for="descripcion" class="form-label fw-bold">Descripci√≥n / Razones</label>
                            <textarea id="descripcion" name="descripcion" class="form-control" rows="4" placeholder="Detalla brevemente las razones del despido..."></textarea>
                            <small class="form-text text-muted">Campo opcional pero recomendado para auditor√≠a</small>
                        </div>
                        
                        <!-- Botones -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danger btn-lg">
                                <i class="fas fa-check-circle"></i> Registrar Despido y Generar Liquidaci√≥n
                            </button>
                            <a href="{{ url_for('rrhh.listar_empleados') }}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panel de informaci√≥n (Derecha) -->
        <div class="col-md-4">
            <!-- Preview de C√°lculos (SIEMPRE VISIBLE) -->
            <div id="div_preview_calculos" style="display:none; top: 20px;" class="card bg-light border-success mb-3 sticky-top">
                <div class="card-body">
                    <h5 class="card-title">üìä Preview de C√°lculos</h5>
                    <hr>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Indemnizaci√≥n:</strong></td>
                            <td class="text-end"><span id="preview_indemnizacion">$0.00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Aguinaldo (13¬∫):</strong></td>
                            <td class="text-end"><span id="preview_aguinaldo">$0.00</span></td>
                        </tr>
                        <tr>
                            <td><strong>Vacaciones:</strong></td>
                            <td class="text-end"><span id="preview_vacaciones">$0.00</span></td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>Subtotal:</strong></td>
                            <td class="text-end"><strong><span id="preview_subtotal">$0.00</span></strong></td>
                        </tr>
                        <tr>
                            <td><strong>(-) Aporte IPS (9%):</strong></td>
                            <td class="text-end"><span id="preview_ips">-$0.00</span></td>
                        </tr>
                        <tr style="background-color: #d4edda;">
                            <td><strong>TOTAL NETO:</strong></td>
                            <td class="text-end"><strong style="font-size:1.2em;"><span id="preview_neto">$0.00</span></strong></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title">‚ÑπÔ∏è Tipos de Despido</h5>
                    <hr>
                    <h6 class="text-success">‚úì Justificado</h6>
                    <p class="small">Tiene causa legal v√°lida. Indemnizaci√≥n = $0. Requiere demostraci√≥n ante autoridades.</p>
                    
                    <h6 class="text-danger">‚úó Injustificado</h6>
                    <p class="small">Sin causa o causa insuficiente. Indemnizaci√≥n = 1 mes + 1 mes por a√±o (m√°x 12 meses).</p>
                </div>
            </div>
            
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">üí∞ Componentes de Liquidaci√≥n</h5>
                    <hr>
                    <ul class="small list-unstyled">
                        <li><strong>Indemnizaci√≥n:</strong> Depende del tipo de despido y antig√ºedad</li>
                        <li><strong>Aguinaldo:</strong> Proporci√≥n del 13¬∫ sueldo (a√±os trabajados/12)</li>
                        <li><strong>Vacaciones:</strong> D√≠as no gozados √ó (salario/30)</li>
                        <li><strong>Aportes IPS:</strong> 9% del total (empleado)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cargar_datos_empleado() {
    const select = document.getElementById('empleado_id');
    const option = select.options[select.selectedIndex];
    
    if (option.value === '') {
        document.getElementById('div_datos_empleado').style.display = 'none';
        document.getElementById('div_preview_calculos').style.display = 'none';
        // Limpiar preview cuando no hay empleado seleccionado
        document.getElementById('preview_indemnizacion').textContent = '$0.00';
        document.getElementById('preview_aguinaldo').textContent = '$0.00';
        document.getElementById('preview_vacaciones').textContent = '$0.00';
        document.getElementById('preview_subtotal').textContent = '$0.00';
        document.getElementById('preview_ips').textContent = '-$0.00';
        document.getElementById('preview_neto').textContent = '$0.00';
        return;
    }
    
    const salario = parseFloat(option.getAttribute('data-salario'));
    const fechaContrata = new Date(option.getAttribute('data-fecha-ingreso'));
    const hoy = new Date();
    
    // Calcular antig√ºedad en a√±os
    const antiguedad = Math.floor((hoy - fechaContrata) / (365.25 * 24 * 60 * 60 * 1000));
    
    document.getElementById('span_antiguedad').textContent = antiguedad;
    document.getElementById('span_salario').textContent = '$' + salario.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('span_fecha_ingreso').textContent = fechaContrata.toLocaleDateString('es-PY');
    document.getElementById('div_datos_empleado').style.display = 'block';
    
    // Siempre recalcular cuando cambia el empleado
    calcular_indemnizacion();
}

function mostrar_causal() {
    const tipo = document.getElementById('tipo').value;
    const div_causal = document.getElementById('div_causal');
    div_causal.style.display = (tipo === 'justificado') ? 'block' : 'none';
}

function calcular_indemnizacion() {
    const select = document.getElementById('empleado_id');
    const option = select.options[select.selectedIndex];
    
    // Si no hay empleado, no hacer nada
    if (!option.value) return;
    
    const salario = parseFloat(option.getAttribute('data-salario')) || 0;
    const fechaIngreso = option.getAttribute('data-fecha-ingreso');
    
    if (!fechaIngreso || salario <= 0) {
        console.log('Datos incompletos:', {fechaIngreso, salario});
        return;
    }
    
    const fechaContrata = new Date(fechaIngreso);
    const hoy = new Date();
    const antiguedad = Math.floor((hoy - fechaContrata) / (365.25 * 24 * 60 * 60 * 1000));
    const tipo = document.getElementById('tipo').value;
    
    let indemnizacion = 0;
    
    // Calcular indemnizaci√≥n seg√∫n tipo (si se seleccion√≥)
    if (tipo === 'justificado') {
        indemnizacion = 0;
    } else if (tipo === 'injustificado') {
        // 1 mes + 1 por a√±o (m√°x 12 meses)
        const meses = Math.min(1 + antiguedad, 12);
        indemnizacion = meses * salario;
    }
    // Si tipo est√° vac√≠o, indemnizaci√≥n = 0 (es preview provisional)
    
    // Aguinaldo proporcional (respecto al a√±o calendario actual)
    const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);
    const d√≠asTrabajados = Math.floor((hoy - inicioA√±o) / (24 * 60 * 60 * 1000)) + 1;
    const mesesTrabajados = d√≠asTrabajados / 30;
    const aguinaldo = (mesesTrabajados / 12) * salario;
    
    // Vacaciones: 2 d√≠as por mes trabajado
    const vacacionesD√≠as = (mesesTrabajados * 2);
    const vacacionesMonto = (vacacionesD√≠as / 30) * salario;
    
    // Subtotal
    const subtotal = indemnizacion + aguinaldo + vacacionesMonto;
    
    // Aportes IPS (9%)
    const aportes = subtotal * 0.09;
    
    // Neto
    const neto = subtotal - aportes;
    
    // Actualizar preview en tiempo real
    document.getElementById('preview_indemnizacion').textContent = '$' + indemnizacion.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('preview_aguinaldo').textContent = '$' + aguinaldo.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('preview_vacaciones').textContent = '$' + vacacionesMonto.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('preview_subtotal').textContent = '$' + subtotal.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('preview_ips').textContent = '-$' + aportes.toLocaleString('es-PY', {minimumFractionDigits: 2});
    document.getElementById('preview_neto').textContent = '$' + neto.toLocaleString('es-PY', {minimumFractionDigits: 2});
    
    // Mostrar el preview
    document.getElementById('div_preview_calculos').style.display = 'block';
}
</script>
{% endblock %}
